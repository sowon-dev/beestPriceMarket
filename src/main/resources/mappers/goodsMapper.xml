<?xml version="1.0" encoding="UTF-8"?>
<!-- DTD지정  -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.bestpricemarket.mappers.goodsMapper">
  
  <!-- 지은 ******************************************************************************************** -->
    <!-- 상품등록 -->
	<insert id="register" useGeneratedKeys="true" keyProperty="gno" parameterType="com.bestpricemarket.domain.GoodsVO">
 		insert into goods (category, g_m_id, gname, lowestprice, content, regDate, endDate) 
 		values (#{category},#{g_m_id},#{gname},#{lowestprice},#{content},now(),#{endDate})
	</insert>  
  	<!-- 상품등록 -->
  	
  	<!-- gno업데이트 -->
  	<update id="setGno" >
  	 update goods g
	 set g.thumbnail = (select f_name 
                   	   from goodsfile f
				       where g.gno = f.f_g_gno)
	 where g.gno =#{gno};                   
  	</update>
  	<!-- gno업데이트 -->
  	
  	<!-- 상품목록 -->
  	<select id="listGoods" resultType="com.bestpricemarket.domain.GoodsVO">
  		select * 
  		from goods 
  		order by gno desc, regDate desc 
  		limit #{pageStart},#{pageSize}
  	</select> 
  	<!-- 상품목록 -->
  	
  	<!-- 카테고리별 상품 목록 -->
 	<select id="category" resultType="com.bestpricemarket.domain.GoodsVO">
 		select * 
 		from goods 
 		where category = #{category} 
 		order by gno desc, regDate desc 
 		limit #{cri.pageStart},#{cri.pageSize}
 	</select>
 	<!-- 카테고리별 상품 분류 -->
 	
 	<!-- DB goods테이블에 있는 모든 상품글의 개수 가지고 오는 처리 -->
 	<select id="pageCount" resultType="int">
 		select
 		 count(*)
 		from goods 
 	</select>
 	<!-- DB goods테이블에 있는 모든 상품글의 개수 가지고 오는 처리 -->
 	
 	<!-- DB goods테이블에 있는 카테고리별 상품글의 개수 가지고 오는 처리 -->
 	<select id="categoryCount" resultType="int">
 	  select count(*) from goods where category = #{category}
 	</select>
 	<!-- DB goods테이블에 있는 카테고리별 상품글의 개수 가지고 오는 처리 -->
 	
  	<!-- 상품조회 -->
  	<select id="detailGoods" resultType="com.bestpricemarket.domain.GoodsVO">
  		select * from goods where gno = #{gno} 
  	</select>  
  	<!-- 상품조회 -->
  		
  	<!-- 상품 수정 -->
  	<update id="modifyGoods">
  		update goods
  		  set
  		  	category = #{category},
  		    gname = #{gname},
  		    content = #{content},
  		    endDate = #{endDate},
  		    lowestprice = #{lowestprice}
  		  where gno = #{gno}  
  	</update>
  	<!-- 상품 수정 -->
  	
  	<!-- 상품 삭제 -->
  	<delete id="deleteGoods">
  		delete from goods
  		where gno = #{gno}
  	</delete>
  	<!-- 상품 삭제 -->
  	
  	<!-- 첨부파일업로드  -->
	 <insert id="insertFile" parameterType="hashmap">
		<![CDATA[
			insert into goodsfile
			 (f_g_gno,f_oname,f_name,f_size,crea_date,update_date) 
			 values(#{gno},#{f_oname},#{f_name},#{f_size},sysdate(),sysdate())
		]]>
	</insert> 
	<!-- 첨부파일업로드  -->
	
	
	<!-- 첨부파일 조회 -->
	<select id="selectFileList" parameterType="int" resultType="hashMap">
		select fno, f_name, f_oname, round(f_size/1024,1) as f_size, del_chk
		from goodsfile
		where f_g_gno = #{gno}
		and del_chk = 'N'
		order by fno asc
	</select>
  	<!-- 첨부파일 조회 -->
  	
  	<!-- 첨부파일업로드 수정 -->
  	 <update id="updateFile" parameterType="hashMap">
  		update goodsfile set del_chk = 'Y' where fno = #{fno}
  	</update> 
  	<!-- 첨부파일업로드 수정 -->
  	
  	<!-- 첨부파일 다운로드 -->
  	<select id="selectFileInfo" parameterType="hashMap" resultType="hashMap">
		select f_name, f_oname 
		from goodsfile 
		where fno = #{fno}
	</select>
  	<!-- 첨부파일 다운로드 -->
  	
  	<!-- 현재 입찰가 -->
  	<!-- <select id="finalPrice"  resultType="int">
  		select max(p.pm_g_bidprice) 
		from pricemonitoring p join goods g
		on p.pm_g_gno = g.gno 
		where pm_g_gno = #{gno};
  	</select> -->
  	<!-- 현재 입찰가 -->
 	
 
  <!-- 지은 ******************************************************************************************** -->	
  	
  	
     <!-- 상품신고 -->
   	<select id="myInfo" resultType="com.bestpricemarket.domain.MemberVO">
   		select * from member where id = #{id}
   	</select>
   
  	<select id="showReportDetail" resultType="com.bestpricemarket.domain.ReportVO">
  		select g.g_m_id, g.gname, g.gno, m.email
  		from goods g
  		join Member m
  		on g.g_m_id = m.id
  		where gno=#{gno}
  	</select>
  	<!-- 상품신고 -->

 <!-- 입찰하기 -->
  	<select id="getBidding" resultType="com.bestpricemarket.domain.PricemonitoringVO">
  		select * from pricemonitoring where pm_g_gno = #{pm_g_gno} order by pm_g_bidprice desc,timelog desc limit 5
  	</select>
  	
  	<select id="getMaxPrice" resultType="Integer">
  		select max(pm_g_bidprice) from pricemonitoring where pm_g_gno = #{pm_g_gno}
  	</select>
  
  	<insert id="insertBidding">
  		insert into pricemonitoring(pm_g_gno,pm_m_userid,pm_g_bidprice,timelog)
  		values(#{pm_g_gno},#{pm_m_userid},#{pm_g_bidprice},#{timelog})
  	</insert>
<!-- 입찰하기 -->
  
  
  </mapper>